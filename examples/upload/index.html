<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/src/css/style.css">
    <style>
    #listView {
        width:500px;
    }
    </style>
    <script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
</head>
    <body>
        <input type="filepicker" name="myName"/>
        <button onclick="fp.pickAndStore()" name="myName">poop</button>
        <form id="write-form">
            <p>Content body:
                <textarea name="body"></textarea>
            </p>
            <p>or Tweet ID: <input name="tweet-id" type="text" /></p>
            <p>Token: <input type="text" name="lftoken" value="eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9.eyJkb21haW4iOiAibGFicy10NDAyLmZ5cmUuY28iLCAiZXhwaXJlcyI6IDEzODcxMzMzMzAuNjY2NDU1LCAidXNlcl9pZCI6ICJwZXRzXzEifQ.Jd-6HCrguDBriBiu-QOCqNLZb34SGt6nEOuHhuyE8fQ" /></p>
            <input type="submit" />
        </form>
        <div id="listView"></div>

        <script src="../../lib/cajon/cajon.js" type="text/javascript"></script>
        <script src="/requirejs.conf.js" type="text/javascript"></script>
        <script>
            requirejs({
                baseUrl: "/"
            });
        </script>
        <script type="text/javascript">
        // FILEPICKER
            /**  @constructor */
            var FilepickerClient = function() {
            	return this;
        	};
            //goog.addSingletonGetter(FilepickerClient);
            
            /** @type{string} **/
            FilepickerClient.FILEPICKER_SOURCE_URL = '//api.filepicker.io/v1/filepicker.js';
            
            /**
             * The below 2 settings (FILEPICKER_API_KEY/MEDIA_CACHE_URL) default to the dev accounts.
             * Production settings are defined in lfconv/templates/plovr/plovr.prod.base.js
             */
            
            /** @define {string} **/
            FilepickerClient.FILEPICKER_API_KEY = 'AtvGm2B6RR9mDKb8bImIHz';
            /** @define {string} **/
            FilepickerClient.MEDIA_CACHE_URL = 'http://dazfoe7f6de09.cloudfront.net/';
            
            /** FilePicker Options
             * - maxSize should match the value set in the filepicker dashboard.
             * - the ordering of 'services' reflects the ordering in the modal (top-down).
             * @type {Object.<string, Object>}
             **/
            FilepickerClient.FILEPICKER_OPTIONS = {
                PICK: {
                    'container': 'modal',
                    'maxSize': 4*1024*1024, // allows files < 4MB
                    'mimetypes': ['image/*'],
                    'multiple': true,
                    'services': ['COMPUTER', 'WEBCAM', 'IMAGE_SEARCH', 'FACEBOOK', 'INSTAGRAM', 'FLICKR', 'PICASA', 'BOX', 'DROPBOX', 'GOOGLE_DRIVE']
                },
                STORAGE: {
                    'location': 'S3',
                    'access': 'public'
                }
            };
            
            /**
             * Download the Filepicker JS API
             * - if we already called this before, then just callback.
             * - if the global object already exists, log a message and abort
             * @param {function()} callback
             */
            FilepickerClient.prototype.init = function(callback) {
                this.filepicker_ = filepicker;
                this.filepicker_.setKey(FilepickerClient.FILEPICKER_API_KEY);
            };
            
            /**
             * @param {boolean} allowMultiple Whether the FP config should allow multiple
             * @param {Function} successCallback
             */
            FilepickerClient.prototype.pickAndStore = function(allowMultiple, successCallback) {
                var FP_OPTIONS = FilepickerClient.FILEPICKER_OPTIONS;
                allowMultiple = allowMultiple || false;
                successCallback = successCallback || function (inkBlob) {
                    alert('Success!');
                    //debugger
                    //TODO (joao) Create content & write to view
                    
                    var contentToWrite = new Content({
                        body: ''
                    });
                    inkBlob && inkBlob.forEach(function (blob) {
                        contentToWrite.attachments.push({
                            type: 'photo',
                            url: blob.url
                        });
                    }, this);
                    debugger
                    //contentToWrite = CVF.createContentView(contentToWrite);
                    view.write(contentToWrite);
                };
                FP_OPTIONS.PICK['multiple'] = allowMultiple;
                this.filepicker_.pickAndStore(FP_OPTIONS.PICK, FP_OPTIONS.STORAGE, successCallback);
            };
        </script>
        <!-- end FILEPICKER -->
        <script>
        require([
            'streamhub-sdk/content/views/content-list-view',
            'streamhub-sdk/collection',
            'streamhub-sdk/content',
            'streamhub-sdk/content/content-view-factory',
            'streamhub-sdk/util',
            'streamhub-sdk/auth'//,
            //'stream/insert'
        ],function (ListView, Collection, Content, ContentViewFactory, Util, Auth) {//, Insert) {
            var opts = {
                "network": "labs-t402.fyre.co",
                "siteId": "303827",
                "articleId": "xbox-0",
                "environment": "t402.livefyre.com"
            };
            
            var listView = window.view = new ListView({
                initial: 3,
                showMore: 2,
                el: document.getElementById("listView")
            });

            window.Content = Content;//Hack for FP success callback
            window.CVF = new ContentViewFactory();//Hack for FP success callback

            var collection = window.collection =  new Collection(opts);
            
            var archive = window.archive = collection.createArchive();
            
            archive.pipe(listView.more);
            
            var $writeForm = $('#write-form');
            $writeForm.submit(function (e) {
                e.preventDefault();

                var formArray = $writeForm.serializeArray(),
                    body = formArray[0].value,
                    tweetId = formArray[1].value,
                    lftoken = formArray[2].value,
                    contentToWrite;
                if (body) {
                    contentToWrite = new Content(body);
                } else if (tweetId) {
                    contentToWrite = { tweetId: tweetId };
                }
                if (lftoken) {
                    Auth.setToken(lftoken);
                }
                if ( ! Auth.getToken() || ! contentToWrite) {
                    alert("Cant write. Not enough info");
                    return;
                }
                //collection.write(contentToWrite);
                listView.write(contentToWrite);
            });
            
            var fpSrc = '//api.filepicker.io/v1/filepicker.js';
            Util.loadScript(fpSrc, function(err) {
                if (err) {
                    throw 'There was an error loading ' + fpSrc;
                    return;
                }
                var fp = window.fp = new FilepickerClient();
                fp.init();
            }, window.document);
            
        });
        </script>
    </body>
</html>
